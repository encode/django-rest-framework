{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

	    <title>{{ document.title }}</title>

        <link href="{% static 'rest_framework/docs/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/bootstrap-theme.min.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/font-awesome-4.0.3.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/base.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/jquery.json-view.min.css' %}" rel="stylesheet">

        <link href="{% static 'rest_framework/docs/img/favicon.ico' %}" rel="shortcut icon">

        <style>{{ code_style }}</style>
        <style>
        .highlight {background-color: #f7f7f9}
        .checkbox label.control-label {font-weight: bold}
        @media (min-width: 768px) {
            .navbar-nav.navbar-right:last-child {
                margin-right: 0 !important;
            }
        }
        </style>
        <script src="https://unpkg.com/coreapi@0.0.20/dist/coreapi.js"></script>

    </head>

    <body data-spy="scroll" data-target="#sidebar-nav" data-offset="50">

        {% include "rest_framework/docs/sidebar.html" %}

        <div class="container" id="main">
            <div class="row">
                <div class="col-md-12 main-container">
                    {% include "rest_framework/docs/document.html" %}
                </div>
            </div>
        </div>

        {% include "rest_framework/docs/auth/token.html" %}
        {% include "rest_framework/docs/auth/basic.html" %}
        {% include "rest_framework/docs/auth/session.html" %}

        <script src="{% static 'rest_framework/docs/js/jquery-1.10.2.min.js' %}"></script>
        <script src="{% static 'rest_framework/docs/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'rest_framework/docs/js/jquery.json-view.min.js' %}"></script>
        <script>
            function normalizeHTTPHeader(str) {
                return (str.charAt(0).toUpperCase() + str.substring(1))
                    .replace( /-(.)/g, function($1) { return $1.toUpperCase(); })
                    .replace( /(Www)/g, function($1) { return 'WWW'; })
                    .replace( /(Xss)/g, function($1) { return 'XSS'; })
                    .replace( /(Md5)/g, function($1) { return 'MD5'; })
            }

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            let responseDisplay = 'data';
            const coreapi = window.coreapi
            const codec = new coreapi.codecs.CoreJSONCodec()
            const schema = {{ schema }}
            const doc = codec.decode(schema)

            {% if user.is_authenticated %}
                window.auth = {
                    'type': 'session',
                };
                $('#selected-authentication').text('session');
                $('#auth-control').children().removeClass('active');
                $('#auth-control').find("[data-auth='session']").addClass('active');
            {% endif %}

            // Language Control
            $('#language-control li').click(function (event) {
                event.preventDefault();
                const languageMenuItem = $(this).find('a');
                var language = languageMenuItem.data("language")

                var languageControls = $(this).closest('ul').find('li');
                languageControls.find('a').not('[data-language="' + language +'"]').parent().removeClass("active")
                languageControls.find('a').filter('[data-language="' + language +'"]').parent().addClass("active")

                $('#selected-language').text(language)

                var codeBlocks = $('pre.highlight')
                codeBlocks.not('[data-language="' + language +'"]').addClass("hide")
                codeBlocks.filter('[data-language="' + language +'"]').removeClass("hide")
            })

            // API Explorer
            $('form.api-interaction').submit(function(event) {
                event.preventDefault();

                const form = $(this).closest("form");
                const key = form.data("key");
                var params = {};

                const formData = new FormData(form.get()[0]);
                for (var [paramKey, paramValue] of formData.entries()) {
                    var elem = form.find("[name=" + paramKey + "]")
                    var dataType = elem.data('type') || 'string'
                    var dataLocation = elem.data('location')

                    if (dataType === 'integer' && paramValue) {
                        paramValue = parseInt(paramValue)
                    } else if (dataType === 'number' && paramValue) {
                        paramValue = parseFloat(paramValue)
                    } else if (dataType === 'boolean' && paramValue) {
                        paramValue = {
                            'true': true,
                            'false': false
                        }[paramValue.toLowerCase()]
                    } else if (dataType === 'array' && paramValue) {
                        paramValue = JSON.parse(paramValue)
                    }

                    if (dataLocation === 'query' && !paramValue) {
                        continue
                    }
                    params[paramKey] = paramValue
                }

                form.find(":checkbox").each(function( index ) {
                    var name = $(this).attr("name");
                    if (!params.hasOwnProperty(name)) {
                        params[name] = false
                    }
                })

                function requestCallback(request) {
                    let parser = document.createElement('a');
                    parser.href = request.url;
                    const method = request.options.method
                    const path = parser.pathname + parser.hash + parser.search

                    // Filling the main response meta
                    form.closest(".modal-content").find(".toggle-view").removeClass("hide")
                    form.find(".request-method").text(method)
                    form.find(".request-url").text(path)

                    // Filling the raw panel
                    // form.find(".response-raw-request").text(method + ' ' + path + '\n\n')
                }

                function responseCallback(response, responseText) {
                    form.find(".response-status-code").removeClass("label-success").removeClass("label-danger")
                    if (response.ok) {
                        form.find(".response-status-code").addClass("label-success")
                    } else {
                        form.find(".response-status-code").addClass("label-danger")
                    }

                    form.find(".response-status-code").text(response.status)
                    
                    form.find(".meta").removeClass("hide")
                    
                    // Filling the raw panel
                    var panelText = 'HTTP/1.1 ' + response.status + ' ' + response.statusText + '\n';

                    response.headers.forEach((header, key) => {
                        panelText += normalizeHTTPHeader(key) + ': ' + header + '\n'
                    })

                    if (responseText) {
                        panelText += '\n' + responseText
                    }

                    form.find(".response-raw-response").text(panelText)
                }

                let options = {
                    requestCallback: requestCallback, 
                    responseCallback: responseCallback,
                }

                if (window.auth && window.auth.type === 'token') {
                    options.headers = {
                        'Authorization': window.auth.value
                    }
                } else if (window.auth && window.auth.type === 'basic') {
                    const token = window.auth.username + ':' + window.auth.password
                    const hash = window.btoa(token)
                    options.headers = {
                        'Authorization': 'Basic ' + hash
                    }
                } else if (window.auth && window.auth.type === 'session') {
                    options.csrf = {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                }


                const client = new coreapi.Client(options)

                client.action(doc, key, params).then(function (data) {
                    var response = JSON.stringify(data, null, 2);
                    form.find(".request-awaiting").addClass("hide")
                    form.find(".response-raw").addClass("hide")
                    form.find(".response-data").addClass("hide")
                    form.find(".response-data").text('')
                    form.find(".response-data").jsonView(response)

                    if (responseDisplay === 'data') {
                        form.find(".response-data").removeClass("hide")
                    } else {
                        form.find(".response-raw").removeClass("hide")
                    }
                }).catch(function (error) {
                    var response = JSON.stringify(error.content, null, 2);
                    form.find(".request-awaiting").addClass("hide")
                    form.find(".response-raw").addClass("hide")
                    form.find(".response-data").addClass("hide")
                    form.find(".response-data").text('')
                    form.find(".response-data").jsonView(response)

                    if (responseDisplay === 'data') {
                        form.find(".response-data").removeClass("hide")
                    } else {
                        form.find(".response-raw").removeClass("hide")
                    }
                })
            });

            $('.toggle-view button').click(function() {
                responseDisplay = $(this).data("display-toggle");
                $(this).removeClass("btn-default").addClass('btn-info').siblings().removeClass('btn-info');
                if (responseDisplay === 'raw') {
                    $(this).closest(".modal-content").find(".response-raw").removeClass("hide");
                    $(this).closest(".modal-content").find(".response-data").addClass("hide");
                } else {
                    $(this).closest(".modal-content").find(".response-data").removeClass("hide");
                    $(this).closest(".modal-content").find(".response-raw").addClass("hide");
                }
            });

            // Authentication: none
            $('#auth-control').find("[data-auth='none']").click(function (event) {
                event.preventDefault();
                window.auth = null;
                $('#selected-authentication').text('none');
                $('#auth-control').children().removeClass('active');
                $('#auth-control').find("[data-auth='none']").addClass('active');
            })

            // Authentication: token
            $('form.authentication-token-form').submit(function(event) {
                event.preventDefault();
                const form = $(this).closest("form");
                const value = form.find('input').val();
                window.auth = {
                    'type': 'token',
                    'value': value,
                };
                $('#selected-authentication').text('header');
                $('#auth-control').children().removeClass('active');
                $('#auth-control').find("[data-auth='token']").addClass('active');
                $('#auth_token_modal').modal('hide');
            });

            // Authentication: basic
            $('form.authentication-basic-form').submit(function(event) {
                event.preventDefault();
                const form = $(this).closest("form");
                const username = form.find('input#username').val();
                const password = form.find('input#password').val();
                window.auth = {
                    'type': 'basic',
                    'username': username,
                    'password': password,
                };
                $('#selected-authentication').text('basic');
                $('#auth-control').children().removeClass('active');
                $('#auth-control').find("[data-auth='basic']").addClass('active');
                $('#auth_basic_modal').modal('hide');
            });

            // Authentication: session
            $('form.authentication-session-form').submit(function(event) {
                event.preventDefault();
                window.auth = {
                    'type': 'session',
                };
                $('#selected-authentication').text('session');
                $('#auth-control').children().removeClass('active');
                $('#auth-control').find("[data-auth='session']").addClass('active');
                $('#auth_session_modal').modal('hide');
            });
        </script>
    </body>
</html>
