{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

	    <title>{{ document.title }}</title>

        <link href="{% static 'rest_framework/docs/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/bootstrap-theme.min.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/font-awesome-4.0.3.css' %}" rel="stylesheet">
        <link href="{% static 'rest_framework/docs/css/base.css' %}" rel="stylesheet">
        <style>{{ code_style }}</style>
        <style>
        .highlight {background-color: #f7f7f9}
        .checkbox label.control-label {font-weight: bold}
        @media (min-width: 768px) {
            .navbar-nav.navbar-right:last-child {
                margin-right: 0 !important;
            }
        }
        </style>
        <script src="https://unpkg.com/coreapi@0.0.19/dist/coreapi.js"></script>

    </head>

    <body data-spy="scroll" data-target="#sidebar-nav" data-offset="50">

        {% include "rest_framework/docs/sidebar.html" %}

        <div class="container" id="main">
            <div class="row">
                <div class="col-md-12 main-container">
                    {% include "rest_framework/docs/document.html" %}
                </div>
            </div>
        </div>

        <script src="{% static 'rest_framework/docs/js/jquery-1.10.2.min.js' %}"></script>
        <script src="{% static 'rest_framework/docs/js/bootstrap.min.js' %}"></script>
        <script>
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrf = {'X-CSRFToken': getCookie('csrftoken')}

            const coreapi = window.coreapi
            const codec = new coreapi.codecs.CoreJSONCodec()
            const schema = {{ schema }}
            const doc = codec.decode(schema)

            // Language Control
            $('.language-control li a').click(function (event) {
                event.preventDefault();
                var button = $(this)
                var language = button.data("language")

                var languageControls = $('.language-control li a')
                languageControls.not('[data-language="' + language +'"]').parent().removeClass("active")
                languageControls.filter('[data-language="' + language +'"]').parent().addClass("active")

                button.closest(".btn-group").find('.dropdown-toggle span').first().text(language)

                var codeBlocks = $('pre.highlight')
                codeBlocks.not('[data-language="' + language +'"]').addClass("hide")
                codeBlocks.filter('[data-language="' + language +'"]').removeClass("hide")
            })

            // API Explorer

            $('form').submit(function(event) {
                event.preventDefault();

                const form = $(this).closest("form");
                const key = form.data("key");
                var params = {};

                const formData = new FormData(form.get()[0]);
                for (var [paramKey, paramValue] of formData.entries()) {
                    var elem = form.find("[name=" + paramKey + "]")
                    var dataType = elem.data('type') || 'string'
                    var dataLocation = elem.data('location')

                    if (dataType === 'integer' && paramValue) {
                        paramValue = parseInt(paramValue)
                    } else if (dataType === 'number' && paramValue) {
                        paramValue = parseFloat(paramValue)
                    } else if (dataType === 'boolean' && paramValue) {
                        paramValue = {
                            'true': true,
                            'false': false
                        }[paramValue.toLowerCase()]
                    } else if (dataType === 'array' && paramValue) {
                        paramValue = JSON.parse(paramValue)
                    }

                    if (dataLocation === 'query' && !paramValue) {
                        continue
                    }
                    params[paramKey] = paramValue
                }

                form.find(":checkbox").each(function( index ) {
                    var name = $(this).attr("name");
                    if (!params.hasOwnProperty(name)) {
                        params[name] = false
                    }
                })

                function requestCallback(request) {
                    var requestText = request.options.method + ' ' + request.url;

                    var parser = document.createElement('a');
                    parser.href = request.url;

                    form.find(".request-response").text(requestText)
                    form.find(".request-response").removeClass("hide")
                    form.find(".request-method").text(request.options.method)
                    form.find(".request-url").text(parser.pathname + parser.hash + parser.search)
                }

                function responseCallback(response) {
                    form.find(".response-status-code").removeClass("label-success").removeClass("label-danger")
                    if (response.ok) {
                        form.find(".response-status-code").addClass("label-success")
                    } else {
                        form.find(".response-status-code").addClass("label-danger")
                    }

                    form.find(".response-status-code").text(response.status)
                    
                    form.find(".meta").removeClass("hide")
                }

                const client = new coreapi.Client({csrf: csrf, requestCallback: requestCallback, responseCallback: responseCallback})

                client.action(doc, key, params).then(function (data) {
                    var response = JSON.stringify(data, null, 2);
                    form.find(".request-info").addClass("hide")
                    form.find(".response-data").text(response)
                    form.find(".response-data").removeClass("hide")
                    form.find(".response-error").addClass("hide")
                }).catch(function (error) {
                    var response = JSON.stringify(error.content, null, 2);
                    form.find(".request-info").addClass("hide")
                    form.find(".response-error").text(error.message)
                    form.find(".response-data").text(response)
                    form.find(".response-error").removeClass("hide")
                    form.find(".response-data").removeClass("hide")

                    /*form.find(".response-data").addClass("hide")*/
                })
            });
        </script>
    </body>
</html>
